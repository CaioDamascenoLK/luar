<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calend√°rio Lunar & Clima</title>
<style>
:root{--bg-day-start:#a8d8ff;--bg-day-end:#4A90E2;--bg-night-start:#071428;--bg-night-end:#001133;--card:rgba(255,255,255,0.07);}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:18px;transition:background 800ms ease;color:#fff}
.header{width:100%;max-width:1100px;display:flex;gap:12px;align-items:center;justify-content:space-between}
.title{display:flex;flex-direction:column}
.controls{display:flex;gap:8px;align-items:center}
.button{background:var(--card);border:0;padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer;transition:background 0.2s}
.button:hover{background:rgba(255,255,255,0.15)}
.container{width:100%;max-width:1100px;margin-top:18px;display:grid;grid-template-columns:360px 1fr;gap:20px}
.panel{background:var(--card);padding:14px;border-radius:12px}
.weatherTop{display:flex;align-items:center;gap:12px}
.weatherIcon{width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,#fff,#eee);display:grid;place-items:center;color:#333;font-weight:700;font-size:28px}
.small{font-size:13px;color:rgba(255,255,255,0.85)}
.calendarWrap{padding:8px}
.calendarHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.navBtn{background:transparent;border:0;color:inherit;font-size:20px;cursor:pointer}
#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
.day{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:12px;border-radius:10px;min-height:98px;position:relative;overflow:visible}
.day strong{display:block}
.moonLabel{font-size:12px;color:rgba(255,255,255,0.85);text-align:center;margin-top:8px}
.moonReal{width:56px;height:56px;border-radius:50%;background:radial-gradient(circle at 35% 30%, #ffffff,#e6e6e6 60%);position:relative;margin:8px auto;box-shadow:0 8px 18px rgba(0,0,0,0.35)}
.moonReal::after{content:'';position:absolute;inset:0;border-radius:50%;background:rgba(5,17,31,0.98);transform:translateX(var(--shift,18%));transition:transform 600ms cubic-bezier(.22,.9,.26,1),opacity 600ms;opacity:var(--op,1)}
.moonReal .shine{position:absolute;left:8px;top:8px;width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.6);filter:blur(1px)}
.footerNote{font-size:12px;color:rgba(255,255,255,0.7);margin-top:12px}
@media (max-width:980px){.container{grid-template-columns:1fr}.header{flex-direction:column;align-items:flex-start}}
@media (max-width:520px){#calendar{grid-template-columns:repeat(3,1fr)}.moonReal{width:44px;height:44px}}
.status{font-size:13px;color:rgba(255,255,255,0.9);margin-top:8px; font-style:italic;}
</style>
</head>
<body>
<div class="header">
  <div class="title">
    <h1 style="margin:0">Calend√°rio Lunar</h1>
  </div>
  <div class="controls">
    <button id="refreshWeather" class="button">üìç Atualizar GPS</button>
    <button id="themeToggle" class="button">üåó Tema</button>
  </div>
</div>

<div class="container">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="weatherIcon" id="weatherIcon">--</div>
        <div>
          <div id="location" class="small">Detectando...</div>
          <div id="tempMain" style="font-size:22px;font-weight:600">‚Äî</div>
          <div id="desc" class="small">‚Äî</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="small">Nascer: <span id="sunrise">--:--</span></div>
        <div class="small">P√¥r: <span id="sunset">--:--</span></div>
        <div class="small">Lua Hoje: <span id="moonPhaseText">‚Äî</span></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1;min-width:140px">
        <div class="small">Coordenadas</div>
        <div id="coords" class="small">...</div>
      </div>
      <div style="min-width:140px">
        <div class="small">Umidade</div>
        <div id="humidity" class="small">‚Äî</div>
      </div>
      <div style="min-width:140px">
        <div class="small">Vento</div>
        <div id="wind" class="small">‚Äî</div>
      </div>
    </div>

    <div class="status" id="status">Status: aguardando permiss√£o...</div>
  </div>

  <div class="panel calendarWrap">
    <div class="calendarHeader">
      <div style="display:flex;gap:8px;align-items:center">
        <button class="navBtn" id="prevMonth">‚óÄ</button>
        <div id="monthLabel" style="font-weight:600"></div>
        <button class="navBtn" id="nextMonth">‚ñ∂</button>
      </div>
      <div class="small">M√™s/ano</div>
    </div>

    <div id="calendar"></div>
  </div>
</div>

<script>
// ===== CONFIGURA√á√ÉO =====
// Chave atualizada conforme solicitado
const API_KEY = "56959adc6fee8ffa3319d7d7572e45f8"; 

// ===== UTILIDADES E UI =====
const refreshBtn = document.getElementById('refreshWeather');
const statusEl = document.getElementById('status');

refreshBtn.addEventListener('click', ()=>{ resolveAndShowWeather(); });

function status(msg){ statusEl.textContent = 'Status: ' + msg; }

// Theme Toggle
const themeToggle = document.getElementById('themeToggle');
let forcedTheme = null; 
function applyTheme(night){
  if(forcedTheme !== null) night = forcedTheme;
  if(night) document.body.style.background = 'linear-gradient(180deg,var(--bg-night-start),var(--bg-night-end))';
  else document.body.style.background = 'linear-gradient(180deg,var(--bg-day-start),var(--bg-day-end))';
}
themeToggle.addEventListener('click', ()=>{ 
    forcedTheme = forcedTheme===null ? !(getIsDaytime()) : (forcedTheme ? null : true); 
    applyTheme(forcedTheme===null ? !getIsDaytime() : forcedTheme); 
});

// ===== CALEND√ÅRIO LUNAR =====
let viewYear, viewMonth;
const nowGlobal = new Date();
viewYear = nowGlobal.getFullYear(); viewMonth = nowGlobal.getMonth();

const monthLabel = document.getElementById('monthLabel');
const calendarEl = document.getElementById('calendar');
const prevBtn = document.getElementById('prevMonth');
const nextBtn = document.getElementById('nextMonth');

prevBtn.addEventListener('click', ()=>{ viewMonth--; if(viewMonth<0){viewMonth=11; viewYear--;} renderCalendar(); });
nextBtn.addEventListener('click', ()=>{ viewMonth++; if(viewMonth>11){viewMonth=0; viewYear++;} renderCalendar(); });

function moonIllumination(date){
  const yy = date.getFullYear();
  const mm = date.getMonth()+1;
  const dd = date.getDate() + (date.getHours()/24) + (date.getMinutes()/1440);
  let y = yy; let m = mm;
  if(m < 3){ y--; m += 12; }
  ++m;
  const c = 365.25 * y;
  const e = 30.6 * m;
  const jd = c + e + dd - 694039.09; 
  const syn = 29.5305882;
  const days = jd % syn;
  const age = days < 0 ? days + syn : days;
  const phase = age / syn; // 0..1
  const illum = (1 - Math.cos(2*Math.PI*phase)) / 2;
  return {age: age, phase: phase, illum: illum};
}

function phaseNameFromPhase(phase){
  if(phase < 0.03 || phase > 0.97) return 'Nova';
  if(phase < 0.22) return 'Crescente fina';
  if(phase < 0.28) return 'Quarto Crescente';
  if(phase < 0.47) return 'Gibosa Crescente';
  if(phase < 0.53) return 'Cheia';
  if(phase < 0.72) return 'Gibosa Minguante';
  if(phase < 0.78) return 'Quarto Minguante';
  return 'Minguante fina';
}

function createMoonElement(phase){
  const wrap = document.createElement('div');
  wrap.className = 'moonReal';
  const shiftPct = (0.5 - phase) * 60; 
  const illum = (1 - Math.cos(2*Math.PI*phase)) / 2;
  const op = 1 - illum;
  wrap.style.setProperty('--shift', shiftPct + '%');
  wrap.style.setProperty('--op', String(op));
  const shine = document.createElement('div'); shine.className='shine'; wrap.appendChild(shine);
  return wrap;
}

function renderCalendar(){
  const monthNames = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  monthLabel.textContent = monthNames[viewMonth] + ' ' + viewYear;
  calendarEl.innerHTML = '';
  const weekDays = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
  for(const wd of weekDays){ const h = document.createElement('div'); h.style.opacity=0.8; h.style.fontSize='13px'; h.style.textAlign='center'; h.style.padding='6px 0'; h.textContent = wd; calendarEl.appendChild(h); }
  const first = new Date(viewYear, viewMonth, 1).getDay();
  const last = new Date(viewYear, viewMonth+1, 0).getDate();
  for(let i=0;i<first;i++){ const blank = document.createElement('div'); blank.className='day'; blank.style.background='transparent'; blank.style.boxShadow='none'; calendarEl.appendChild(blank); }
  for(let d=1; d<=last; d++){
    const date = new Date(viewYear, viewMonth, d, 12, 0);
    const info = moonIllumination(date);
    const day = document.createElement('div'); day.className='day'; const num = document.createElement('strong'); num.textContent = d; day.appendChild(num);
    const moonEl = createMoonElement(info.phase); day.appendChild(moonEl);
    const label = document.createElement('div'); label.className='moonLabel'; label.textContent = phaseNameFromPhase(info.phase) + ' ‚Ä¢ ' + Math.round(info.illum*100) + '%'; day.appendChild(label);
    calendarEl.appendChild(day);
  }
}

// ===== L√ìGICA DE CLIMA E API =====
async function fetchWeatherForCoords(lat, lon){
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=pt_br&appid=${API_KEY}`;
  try{ 
    const res = await fetch(url); 
    if(!res.ok) { 
        if(res.status === 401) throw new Error('API Key inv√°lida (erro 401).');
        if(res.status === 404) throw new Error('Local n√£o encontrado (404).');
        throw new Error('Erro na API: '+res.status); 
    } 
    const data = await res.json(); 
    return data; 
  } catch(err){ 
    console.error('fetchWeather error',err); 
    status('Erro ao conectar com OpenWeather: ' + err.message);
    return null; 
  }
}

function getIsDaytime(){
  const h = new Date().getHours(); return h>=6 && h<18;
}

// L√≥gica de localiza√ß√£o simplificada (APENAS GPS)
function resolveAndShowWeather(){
  status('Solicitando localiza√ß√£o GPS...');
  
  if(!navigator.geolocation){
    status('Erro: Seu navegador n√£o suporta Geolocaliza√ß√£o.');
    document.getElementById('location').textContent = "Sem suporte GPS";
    return;
  }

  const options = {
    enableHighAccuracy: false,
    timeout: 10000,
    maximumAge: 0
  };

  navigator.geolocation.getCurrentPosition(
    // Sucesso
    async (pos) => {
      const lat = pos.coords.latitude; 
      const lon = pos.coords.longitude;
      document.getElementById('coords').textContent = lat.toFixed(4)+', '+lon.toFixed(4);
      status('GPS obtido. Carregando clima...');
      
      const w = await fetchWeatherForCoords(lat, lon);
      if(w) applyWeatherToUI(w);
    },
    // Erro
    (err) => {
      console.warn('Erro GPS:', err);
      let msg = 'Erro desconhecido de GPS.';
      if(err.code === 1) msg = 'Permiss√£o de localiza√ß√£o negada.';
      if(err.code === 2) msg = 'Localiza√ß√£o indispon√≠vel.';
      if(err.code === 3) msg = 'Tempo esgotado ao buscar local.';
      
      status(msg);
      document.getElementById('location').textContent = "Local n√£o detectado";
      alert(msg + " Por favor, permita o acesso √† localiza√ß√£o para ver o clima.");
    },
    options
  );
}

function applyWeatherToUI(w){
  if(!w) return;
  const iconBox = document.getElementById('weatherIcon');
  const tempBox = document.getElementById('tempMain');
  const descBox = document.getElementById('desc');
  const locBox = document.getElementById('location');
  const hum = document.getElementById('humidity');
  const wind = document.getElementById('wind');
  const sunrise = document.getElementById('sunrise');
  const sunset = document.getElementById('sunset');
  const moonPhaseText = document.getElementById('moonPhaseText');

  const weatherMain = w.weather && w.weather[0] ? w.weather[0].main : '‚Äî';
  const weatherDesc = w.weather && w.weather[0] ? w.weather[0].description : '‚Äî';
  
  tempBox.textContent = (w.main && w.main.temp !== undefined) ? Math.round(w.main.temp)+'¬∞C' : '‚Äî';
  descBox.textContent = weatherDesc;
  locBox.textContent = (w.name || 'Local desconhecido') + (w.sys && w.sys.country ? ', ' + w.sys.country : '');
  hum.textContent = (w.main && w.main.humidity) ? w.main.humidity + '%' : '‚Äî';
  wind.textContent = (w.wind && w.wind.speed) ? w.wind.speed + ' m/s' : '‚Äî';

  const sr = w.sys && w.sys.sunrise ? new Date(w.sys.sunrise*1000) : null;
  const ss = w.sys && w.sys.sunset ? new Date(w.sys.sunset*1000) : null;
  sunrise.textContent = sr ? sr.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '--:--';
  sunset.textContent = ss ? ss.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '--:--';

  const mi = moonIllumination(new Date());
  moonPhaseText.textContent = phaseNameFromPhase(mi.phase) + ' (' + Math.round(mi.illum*100) + '%)';

  const nowTs = Date.now()/1000;
  let isDay = true;
  if(w.sys && w.sys.sunrise && w.sys.sunset){ isDay = nowTs >= w.sys.sunrise && nowTs < w.sys.sunset; }
  applyTheme(!isDay);

  const map = {
    'Clear':'‚òÄ', 'Clouds':'‚òÅ', 'Rain':'üåß', 'Drizzle':'üå¶', 'Thunderstorm':'‚õà', 'Snow':'‚ùÑ', 'Mist':'üå´', 'Smoke':'üå´', 'Haze':'üå´', 'Dust':'üå´', 'Fog':'üå´', 'Sand':'üå´', 'Ash':'üå´', 'Squall':'üå¨', 'Tornado':'üå™'
  };
  iconBox.textContent = map[weatherMain] || '‚Ñπ';
  status('Clima atualizado.');
}

// Inicializa√ß√£o
renderCalendar(); 
applyTheme(!getIsDaytime());
// Tenta carregar automaticamente
resolveAndShowWeather();

// Atualiza a cada 10 min
setInterval(()=>{ resolveAndShowWeather(); }, 10*60*1000);

</script>
</body>
</html>